name: Auto Create Release on Merge

on:
  push:
    branches: [ main ]
    paths:
      - 'contributions/**'
  pull_request_target:
    types: [closed]
    branches: [ main ]
    paths:
      - 'contributions/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-release:
    if: github.event_name != 'pull_request_target' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Install snarkjs
        run: npm install -g snarkjs@latest

      - name: Get Latest Contribution
        id: contrib
        run: |
          # Get the latest merged zkey
          LATEST_ZKEY=$(find contributions contributes -name "*.zkey" -printf '%T@ %p\n' 2>/dev/null | sort -r | head -n1 | cut -d' ' -f2-)
          if [ -z "$LATEST_ZKEY" ]; then
            echo "No zkey file found under contributions/ or contributes/." >&2
            exit 1
          fi
          echo "latest_zkey=$LATEST_ZKEY" >> $GITHUB_OUTPUT

          # Calculate next version
          LATEST_TAG=$(git describe --tags --abbrev=0 || echo "v0000")
          NEXT_NUM=$(printf "%04d" $((10#${LATEST_TAG:1} + 1)))
          echo "next_tag=v$NEXT_NUM" >> $GITHUB_OUTPUT

      - name: Verify Final zkey (safety check)
        run: |
          PTAU_FILE="ppot_0080_12.ptau"
          PTAU_URL="https://pse-trusted-setup-ppot.s3.eu-central-1.amazonaws.com/pot28_0080/ppot_0080_12.ptau"
          curl -L -o "$PTAU_FILE" "$PTAU_URL"
          snarkjs zkey verify circuits/flag_verifier.r1cs "$PTAU_FILE" "${{ steps.contrib.outputs.latest_zkey }}"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.contrib.outputs.next_tag }}
          name: Contribution ${{ steps.contrib.outputs.next_tag }}
          generate_release_notes: true
          files: |
            ${{ steps.contrib.outputs.latest_zkey }}
          token: ${{ secrets.GITHUB_TOKEN }}
