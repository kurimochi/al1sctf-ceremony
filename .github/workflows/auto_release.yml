name: Auto Create Release on Merge

on:
  workflow_run:
    workflows: ["Verify Contribution"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  auto-release:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Check trigger eligibility
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('should_release', 'true')
              core.setOutput('reason', 'manual dispatch')
              return
            }

            const run = context.payload.workflow_run
            if (!run || run.event !== 'pull_request') {
              core.setOutput('should_release', 'false')
              core.setOutput('reason', 'not a pull_request workflow run')
              return
            }

            const prs = run.pull_requests || []
            if (prs.length === 0) {
              core.setOutput('should_release', 'false')
              core.setOutput('reason', 'no related pull request in workflow_run payload')
              return
            }

            const prNumber = prs[0].number
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            })

            if (!pr.merged) {
              core.setOutput('should_release', 'false')
              core.setOutput('reason', `pr #${prNumber} is not merged`) 
              return
            }

            if (pr.base.ref !== 'main') {
              core.setOutput('should_release', 'false')
              core.setOutput('reason', `pr #${prNumber} base is ${pr.base.ref}, not main`)
              return
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            })

            const hasContributionChange = files.some((f) =>
              f.filename.startsWith('contributions/') || f.filename.startsWith('contributes/')
            )

            core.setOutput('should_release', hasContributionChange ? 'true' : 'false')
            core.setOutput(
              'reason',
              hasContributionChange
                ? `pr #${prNumber} merged with contribution changes`
                : `pr #${prNumber} merged without contribution changes`
            )

      - name: Log trigger decision
        run: 'echo "Auto release gate: ${{ steps.gate.outputs.reason }}"'

      - name: Checkout
        if: steps.gate.outputs.should_release == 'true'
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          ref: main

      - name: Setup Node.js
        if: steps.gate.outputs.should_release == 'true'
        uses: actions/setup-node@v4

      - name: Install snarkjs
        if: steps.gate.outputs.should_release == 'true'
        run: npm install -g snarkjs@latest

      - name: Get Latest Contribution
        id: contrib
        if: steps.gate.outputs.should_release == 'true'
        run: |
          # Get the latest merged zkey
          LATEST_ZKEY=$(find contributions contributes -name "*.zkey" -printf '%T@ %p\n' 2>/dev/null | sort -r | head -n1 | cut -d' ' -f2-)
          if [ -z "$LATEST_ZKEY" ]; then
            echo "No zkey file found under contributions/ or contributes/." >&2
            exit 1
          fi
          echo "latest_zkey=$LATEST_ZKEY" >> $GITHUB_OUTPUT

          # Calculate next version
          LATEST_TAG=$(git describe --tags --abbrev=0 || echo "v0000")
          NEXT_NUM=$(printf "%04d" $((10#${LATEST_TAG:1} + 1)))
          echo "next_tag=v$NEXT_NUM" >> $GITHUB_OUTPUT

      - name: Verify Final zkey (safety check)
        if: steps.gate.outputs.should_release == 'true'
        run: |
          PTAU_FILE="ppot_0080_12.ptau"
          PTAU_URL="https://pse-trusted-setup-ppot.s3.eu-central-1.amazonaws.com/pot28_0080/ppot_0080_12.ptau"
          curl -L -o "$PTAU_FILE" "$PTAU_URL"
          snarkjs zkey verify circuits/flag_verifier.r1cs "$PTAU_FILE" "${{ steps.contrib.outputs.latest_zkey }}"

      - name: Create Release
        if: steps.gate.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.contrib.outputs.next_tag }}
          name: Contribution ${{ steps.contrib.outputs.next_tag }}
          generate_release_notes: true
          files: |
            ${{ steps.contrib.outputs.latest_zkey }}
          token: ${{ secrets.GITHUB_TOKEN }}
